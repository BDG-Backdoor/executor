name: Run Reorganize Script and Create PR

# Controls when the workflow will run
on:
  push:
    branches: [ main ]

# A workflow run is made up of one or more jobs
jobs:
  run-script-and-pr:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
    # Checks out your repository under $GITHUB_WORKSPACE, so your job can access it
    - uses: actions/checkout@v3
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        ref: main  # Check out the main branch

    # Runs a single command using the runners shell
    - name: Make script executable
      run: chmod +x reorganize.sh

    # Set up environment variables including GITHUB_TOKEN
    - name: Set up environment
      run: echo "GITHUB_TOKEN=${{ secrets.GITHUB_TOKEN }}" >> $GITHUB_ENV

    # Runs the reorganize.sh script
    - name: Execute reorganize script
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: ./reorganize.sh

    # Commit changes if any
    - name: Commit changes
      id: commit
      run: |
        git config --global user.name 'GitHub Actions'
        git config --global user.email 'actions@github.com'
        git add .
        if git diff --staged --quiet; then
          echo "no_changes=true" >> $GITHUB_OUTPUT
          echo "No changes to commit."
        else
          git commit -m "Automated changes by reorganize.sh"
          echo "no_changes=false" >> $GITHUB_OUTPUT
        fi
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    # Create a pull request if there are changes
    - name: Create Pull Request
      if: steps.commit.outputs.no_changes == 'false'  # Only if there are changes
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: 'Automated changes by reorganize.sh'
        title: '[Automated] Reorganize Script Changes'
        body: |
          This pull request was automatically generated by the `reorganize.sh` script.
          It contains changes made during the workflow run.
        branch: reorganize-changes
        base: main

    # Optional: Notify if no changes were made
    - name: No changes to commit
      if: steps.commit.outputs.no_changes == 'true'
      run: echo "No changes were made by the reorganize script."